---
title: "Global_a2"
author: "Quintijn de Leng"
date: "24-3-2022"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

```{r libraries, message=FALSE, warning=FALSE}
library(mice)
library(dplyr)
library(ggplot2)
library(naniar)
library(tidyr)
library(caret)
library(cowplot)
library(Hmisc)
library(Metrics)
library(miceadds)
```

```{r}
dfcom <- readRDS("complete_data.rds")
dfinc <- readRDS("incomplete_data_g9.rds")
```

## Setting up the dataset for imputation

```{r}
#Better way to calculate the missing weights!
prep_ini <- mice(dfinc, maxit = 0)
prep_ini_meth <- prep_ini$method
prep_ini_meth[c("smoke", "active", "height", "bmi")] <- ""
prep_ini_meth["weight"] <- "~ I(bmi * (height / 100)^2)"
imp_prep <- mice(dfinc,
                m = 1,
                maxit = 1,
                method = prep_ini_meth,
                print = FALSE)
dfinc <- complete(imp_prep)
```

As in the last assignment, we re-calculate some missing cases of *weight* to reflect the actual non-missingness of these cases. This time, we avoid recalculating all cases of *weight*.

##Setting up the imputation model

```{r}
ini <- mice(dfinc, maxit = 0)
meth <- ini$method
meth["bmi"] <- "~ I(weight / (height / 100)^2)"
pred <- ini$predictorMatrix
pred[c("weight", "height"), "bmi"] <- 0

imp1 <- mice(dfinc,
             m = 5,
             maxit = 10,
             method = meth,
             predictorMatrix = pred,
             seed = 1337,
             print = FALSE)

```



```{r}
plot(imp1)
densityplot(imp1)
stripplot(imp1)
```

Using five iterations, we did not yet see a convergence in some variables. After 10 iterations, all variables showed convergence.

```{r}
xyplot(imp1, 
       bmi ~ I(weight / (height / 100)^2), 
       ylab="Imputed BMI", 
       xlab="Calculated BMI")
```
```{r}
xyplot(imp1, 
       weight ~ I(bmi * (height / 100)^2), 
       ylab="Imputed weight", 
       xlab="Calculated weight")
```

##Comparison of imputed and complete data

```{r}
impmeans <- complete(imp1, "all") %>% 
            lapply(function(x) select(x, where(is.numeric)) %>% colMeans()) %>%
            do.call(rbind, .) %>%
            colMeans()
#From: Lang (2022, 3 december)
impmeans <- as.data.frame(impmeans)
compmeans <- colMeans(dfcom[, c(1, 5:9)]) %>% 
        as.data.frame()
meantable <- cbind(impmeans, compmeans)
colnames(meantable) <- (c("imputed", "complete"))
meantable$difference <- round(meantable$complete - meantable$imputed, 2)
meantable[c(2, 4:6), ]
```

```{r}


impdat <- complete(imp1 ,action="long",include = FALSE)
pool_mean <- with(impdat, by(impdat, .imp, function(x) c(var(x$active), var(x$height), var(x$weight), var(x$bmi))))
pool_mean <- Reduce("+",pool_mean)/length(pool_mean)
vartab <- as.data.frame(pool_mean)

```


The differences between the imputed and complete data are relatively small. 

```{r}
test <- micombine.cor(mi.res = imp1, variables = c(5, 7:9))
attr(test, "r_matrix")


acv <- var(dfcom$active)
hcv <- var(dfcom$height)
wcv <- var(dfcom$weight)
bcv <- var(dfcom$bmi)

t <- as.data.frame(c(acv, hcv, wcv, bcv))

```


##Sources
Chunk 9: Lang, K. (2022, 3 december). *Missing Data Theory & Causal Effects, practical 6, sec. 2.2* [R code]. 


#TODO:
#kijken naar alternatieven predictive mean matching
#kijken naar predictor matrix en collineariteit